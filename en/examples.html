

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Examples &mdash; ModbusLink 1.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=6efca38a"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Best Practices Guide" href="best_practices.html" />
    <link rel="prev" title="User Guide" href="user_guide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="index.html" class="icon icon-home">
            ModbusLink
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html#second-demo">30-Second Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html#main-transport-methods">Main Transport Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html#advanced-data-types">Advanced Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html#high-performance-async-operations">High-Performance Async Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html#local-testing-environment">Local Testing Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html#error-handling">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html#next-steps">Next Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Design</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="user_guide.html">User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Practices</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basic-examples">Basic Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#simple-tcp-client">Simple TCP Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-rtu-client">Simple RTU Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-ascii-client">Simple ASCII Client</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-examples">Advanced Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#asynchronous-operations">Asynchronous Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#asynchronous-rtu-operations">Asynchronous RTU Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#asynchronous-ascii-operations">Asynchronous ASCII Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#callback-mechanisms">Callback Mechanisms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-data-types">Advanced Data Types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#performance-testing-examples">Performance Testing Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#batch-operation-performance">Batch Operation Performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-pool-example">Connection Pool Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#error-handling-examples">Error Handling Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#comprehensive-error-handling">Comprehensive Error Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging-configuration">Logging Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#integration-examples">Integration Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-acquisition-system">Data Acquisition System</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#server-examples">Server Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#basic-tcp-server">Basic TCP Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtu-server-example">RTU Server Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ascii-server-example">ASCII Server Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-server-example">Multi-Server Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#process-control-system">Process Control System</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html">Best Practices Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#connection-management">Connection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#error-handling">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#performance-optimization">Performance Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#data-validation">Data Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#monitoring-and-diagnostics">Monitoring and Diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#configuration-management">Configuration Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#production-best-practices">Production Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#testing-strategy">Testing Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html#summary">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#connection-issues">Connection Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#protocol-errors">Protocol Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#performance-issues">Performance Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#data-issues">Data Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#debugging-and-monitoring">Debugging and Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#common-error-reference">Common Error Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#prevention-measures">Prevention Measures</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html#getting-help">Getting Help</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ModbusLink</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Examples</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/examples.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Link to this heading"></a></h1>
<p>This section provides comprehensive examples demonstrating various features of ModbusLink.</p>
<section id="basic-examples">
<h2>Basic Examples<a class="headerlink" href="#basic-examples" title="Link to this heading"></a></h2>
<section id="simple-tcp-client">
<h3>Simple TCP Client<a class="headerlink" href="#simple-tcp-client" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModbusClient</span><span class="p">,</span> <span class="n">TcpTransport</span>

<span class="c1"># Create TCP transport</span>
<span class="n">transport</span> <span class="o">=</span> <span class="n">TcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">502</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">ModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Connect to the server</span>
    <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># Read holding registers</span>
    <span class="n">registers</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registers: </span><span class="si">{</span><span class="n">registers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Write single register</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write_single_register</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="mi">1234</span>
    <span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="simple-rtu-client">
<h3>Simple RTU Client<a class="headerlink" href="#simple-rtu-client" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModbusClient</span><span class="p">,</span> <span class="n">RtuTransport</span>

<span class="c1"># Create RTU transport</span>
<span class="n">transport</span> <span class="o">=</span> <span class="n">RtuTransport</span><span class="p">(</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;COM1&#39;</span><span class="p">,</span>
    <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
    <span class="n">bytesize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">parity</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span>
    <span class="n">stopbits</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">ModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

<span class="k">with</span> <span class="n">client</span><span class="p">:</span>
    <span class="c1"># Read coils</span>
    <span class="n">coils</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_coils</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coils: </span><span class="si">{</span><span class="n">coils</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Write multiple coils</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write_multiple_coils</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="simple-ascii-client">
<h3>Simple ASCII Client<a class="headerlink" href="#simple-ascii-client" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModbusClient</span><span class="p">,</span> <span class="n">AsciiTransport</span>

<span class="c1"># Create ASCII transport</span>
<span class="n">transport</span> <span class="o">=</span> <span class="n">AsciiTransport</span><span class="p">(</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;COM1&#39;</span><span class="p">,</span>
    <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
    <span class="n">bytesize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">parity</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span>
    <span class="n">stopbits</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">ModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

<span class="k">with</span> <span class="n">client</span><span class="p">:</span>
    <span class="c1"># Read holding registers</span>
    <span class="n">registers</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="mi">4</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registers: </span><span class="si">{</span><span class="n">registers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Write single register</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write_single_register</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="mi">1234</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-examples">
<h2>Advanced Examples<a class="headerlink" href="#advanced-examples" title="Link to this heading"></a></h2>
<section id="asynchronous-operations">
<h3>Asynchronous Operations<a class="headerlink" href="#asynchronous-operations" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncTcpTransport</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_modbus_operations</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncTcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">502</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="c1"># Concurrent read operations</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span><span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span><span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span><span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">registers</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Block </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">registers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Sequential write operations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">write_single_register</span><span class="p">(</span>
                <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">address</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="p">)</span>

<span class="c1"># Run the async function</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">async_modbus_operations</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="asynchronous-rtu-operations">
<h3>Asynchronous RTU Operations<a class="headerlink" href="#asynchronous-rtu-operations" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncRtuTransport</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_rtu_operations</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncRtuTransport</span><span class="p">(</span>
        <span class="n">port</span><span class="o">=</span><span class="s1">&#39;COM1&#39;</span><span class="p">,</span>
        <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="c1"># Async read holding registers</span>
        <span class="n">registers</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registers: </span><span class="si">{</span><span class="n">registers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Async write multiple registers</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">write_multiple_registers</span><span class="p">(</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>
        <span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">async_rtu_operations</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="asynchronous-ascii-operations">
<h3>Asynchronous ASCII Operations<a class="headerlink" href="#asynchronous-ascii-operations" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncAsciiTransport</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_ascii_operations</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncAsciiTransport</span><span class="p">(</span>
        <span class="n">port</span><span class="o">=</span><span class="s1">&#39;COM1&#39;</span><span class="p">,</span>
        <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="c1"># Async read coils</span>
        <span class="n">coils</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_coils</span><span class="p">(</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coils: </span><span class="si">{</span><span class="n">coils</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Async write single coil</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">write_single_coil</span><span class="p">(</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">async_ascii_operations</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="callback-mechanisms">
<h3>Callback Mechanisms<a class="headerlink" href="#callback-mechanisms" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncTcpTransport</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="k">def</span><span class="w"> </span><span class="nf">on_data_received</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data received: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">on_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error occurred: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">callback_example</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncTcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">502</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

    <span class="c1"># Set callbacks</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_data_callback</span><span class="p">(</span><span class="n">on_data_received</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_error_callback</span><span class="p">(</span><span class="n">on_error</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="c1"># Operations will trigger callbacks</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">callback_example</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="advanced-data-types">
<h3>Advanced Data Types<a class="headerlink" href="#advanced-data-types" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModbusClient</span><span class="p">,</span> <span class="n">TcpTransport</span>

<span class="n">transport</span> <span class="o">=</span> <span class="n">TcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">502</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">ModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

<span class="k">with</span> <span class="n">client</span><span class="p">:</span>
    <span class="c1"># Float32 operations</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="mf">25.6</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write_float32</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">temperature</span>
    <span class="p">)</span>

    <span class="n">read_temp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_float32</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">100</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temperature: </span><span class="si">{</span><span class="n">read_temp</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>

    <span class="c1"># Int32 operations with custom byte/word order</span>
    <span class="n">counter_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">123456</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write_int32</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">102</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">counter_value</span><span class="p">,</span>
        <span class="n">byte_order</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">,</span>
        <span class="n">word_order</span><span class="o">=</span><span class="s1">&#39;big&#39;</span>
    <span class="p">)</span>

    <span class="n">read_counter</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_int32</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">102</span><span class="p">,</span>
        <span class="n">byte_order</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">,</span>
        <span class="n">word_order</span><span class="o">=</span><span class="s1">&#39;big&#39;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counter: </span><span class="si">{</span><span class="n">read_counter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># UInt32 operations</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1640995200</span>  <span class="c1"># Unix timestamp</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write_uint32</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">104</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">timestamp</span>
    <span class="p">)</span>

    <span class="n">read_timestamp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_uint32</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">104</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timestamp: </span><span class="si">{</span><span class="n">read_timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-testing-examples">
<h2>Performance Testing Examples<a class="headerlink" href="#performance-testing-examples" title="Link to this heading"></a></h2>
<section id="batch-operation-performance">
<h3>Batch Operation Performance<a class="headerlink" href="#batch-operation-performance" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncTcpTransport</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">performance_test</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncTcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">502</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="c1"># Test batch read performance</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Concurrent read of multiple register blocks</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
                <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">start_address</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading 100 registers took: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average per register: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">performance_test</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="connection-pool-example">
<h3>Connection Pool Example<a class="headerlink" href="#connection-pool-example" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncTcpTransport</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ModbusConnectionPool</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span> <span class="o">=</span> <span class="n">pool_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span><span class="p">):</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncTcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">return_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<span class="c1"># Usage example</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">use_connection_pool</span><span class="p">():</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">ModbusConnectionPool</span><span class="p">(</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="mi">502</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">pool</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get connection</span>
        <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>

        <span class="c1"># Perform operations</span>
        <span class="n">registers</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read result: </span><span class="si">{</span><span class="n">registers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return connection</span>
        <span class="k">await</span> <span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">pool</span><span class="o">.</span><span class="n">close_all</span><span class="p">()</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">use_connection_pool</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
<section id="error-handling-examples">
<h2>Error Handling Examples<a class="headerlink" href="#error-handling-examples" title="Link to this heading"></a></h2>
<section id="comprehensive-error-handling">
<h3>Comprehensive Error Handling<a class="headerlink" href="#comprehensive-error-handling" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModbusClient</span><span class="p">,</span> <span class="n">TcpTransport</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink.common.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="ne">ConnectionError</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">CRCError</span><span class="p">,</span>
    <span class="n">InvalidResponseError</span><span class="p">,</span> <span class="n">ModbusException</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">robust_modbus_client</span><span class="p">():</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">TcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">502</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">ModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">retry_delay</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

            <span class="c1"># Perform operations</span>
            <span class="n">registers</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
                <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully read registers: </span><span class="si">{</span><span class="n">registers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">except</span> <span class="ne">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection failed (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
                <span class="n">retry_delay</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># Exponential backoff</span>

        <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation timed out (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">CRCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRC error detected: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># CRC errors usually indicate communication issues</span>
            <span class="k">break</span>

        <span class="k">except</span> <span class="n">InvalidResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid response received: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">except</span> <span class="n">ModbusException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modbus protocol error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception code: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">exception_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="n">robust_modbus_client</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="logging-configuration">
<h3>Logging Configuration<a class="headerlink" href="#logging-configuration" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModbusClient</span><span class="p">,</span> <span class="n">TcpTransport</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink.utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="c1"># Configure logging</span>
<span class="n">setup_logger</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;modbuslink&#39;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;modbus_operations.log&#39;</span><span class="p">,</span>
    <span class="n">console_output</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Create client with logging enabled</span>
<span class="n">transport</span> <span class="o">=</span> <span class="n">TcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">502</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">ModbusClient</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

<span class="k">with</span> <span class="n">client</span><span class="p">:</span>
    <span class="c1"># All operations will be logged</span>
    <span class="n">registers</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">start_address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>

    <span class="n">client</span><span class="o">.</span><span class="n">write_single_register</span><span class="p">(</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">address</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="mi">1234</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="integration-examples">
<h2>Integration Examples<a class="headerlink" href="#integration-examples" title="Link to this heading"></a></h2>
<section id="data-acquisition-system">
<h3>Data Acquisition System<a class="headerlink" href="#data-acquisition-system" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncTcpTransport</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DataAcquisitionSystem</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncTcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Read multiple data points</span>
                    <span class="n">temperature</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_float32</span><span class="p">(</span>
                        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">100</span>
                    <span class="p">)</span>
                    <span class="n">pressure</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_float32</span><span class="p">(</span>
                        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">102</span>
                    <span class="p">)</span>
                    <span class="n">flow_rate</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_float32</span><span class="p">(</span>
                        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">104</span>
                    <span class="p">)</span>

                    <span class="c1"># Create data record</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">,</span>
                        <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="n">pressure</span><span class="p">,</span>
                        <span class="s1">&#39;flow_rate&#39;</span><span class="p">:</span> <span class="n">flow_rate</span>
                    <span class="p">}</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data acquired: </span><span class="si">{</span><span class="n">record</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Save data periodically</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acquisition error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">)</span><span class="si">}</span><span class="s2"> records to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="c1"># Usage</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">daq</span> <span class="o">=</span> <span class="n">DataAcquisitionSystem</span><span class="p">(</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="mi">502</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">daq</span><span class="o">.</span><span class="n">start_acquisition</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
<section id="server-examples">
<h2>Server Examples<a class="headerlink" href="#server-examples" title="Link to this heading"></a></h2>
<section id="basic-tcp-server">
<h3>Basic TCP Server<a class="headerlink" href="#basic-tcp-server" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncTcpModbusServer</span><span class="p">,</span> <span class="n">ModbusDataStore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Setup logging</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="c1"># Create data store</span>
    <span class="n">data_store</span> <span class="o">=</span> <span class="n">ModbusDataStore</span><span class="p">(</span>
        <span class="n">coils_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">discrete_inputs_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">holding_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">input_registers_size</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">)</span>

    <span class="c1"># Set initial data</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">])</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">254</span><span class="p">])</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_discrete_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>

    <span class="c1"># Create TCP server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">AsyncTcpModbusServer</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">5020</span><span class="p">,</span>
        <span class="n">data_store</span><span class="o">=</span><span class="n">data_store</span><span class="p">,</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">max_connections</span><span class="o">=</span><span class="mi">5</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting TCP server: localhost:5020&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Slave ID: 1&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start server</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TCP server started successfully!&quot;</span><span class="p">)</span>

        <span class="c1"># Run forever</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Received stop signal&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping server...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server stopped&quot;</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="rtu-server-example">
<h3>RTU Server Example<a class="headerlink" href="#rtu-server-example" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncRtuModbusServer</span><span class="p">,</span> <span class="n">ModbusDataStore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">simulate_industrial_data</span><span class="p">(</span><span class="n">data_store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate industrial equipment data&quot;&quot;&quot;</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Simulate temperature sensor data</span>
            <span class="n">base_temps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">248</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">318</span><span class="p">,</span> <span class="mi">447</span><span class="p">,</span> <span class="mi">682</span><span class="p">]</span>
            <span class="n">temp_variations</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">cycle</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">base_temps</span><span class="p">]</span>
            <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">temp_variations</span><span class="p">)</span>

            <span class="c1"># Simulate pressure sensor data</span>
            <span class="n">base_pressures</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1015</span><span class="p">,</span> <span class="mi">1027</span><span class="p">,</span> <span class="mi">996</span><span class="p">,</span> <span class="mi">1043</span><span class="p">,</span> <span class="mi">1004</span><span class="p">]</span>
            <span class="n">pressure_variations</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">cycle</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">))</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">base_pressures</span><span class="p">]</span>
            <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">pressure_variations</span><span class="p">)</span>

            <span class="c1"># Simulate motor speed changes</span>
            <span class="n">current_speeds</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">new_speeds</span> <span class="o">=</span> <span class="p">[</span><span class="n">speed</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="k">for</span> <span class="n">speed</span> <span class="ow">in</span> <span class="n">current_speeds</span><span class="p">]</span>
            <span class="n">new_speeds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="n">speed</span><span class="p">))</span> <span class="k">for</span> <span class="n">speed</span> <span class="ow">in</span> <span class="n">new_speeds</span><span class="p">]</span>
            <span class="n">data_store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_speeds</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cycle</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Industrial data update #</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Temperature: </span><span class="si">{</span><span class="n">temp_variations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pressure: </span><span class="si">{</span><span class="n">pressure_variations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Motor speeds: </span><span class="si">{</span><span class="n">new_speeds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data simulation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Create data store</span>
    <span class="n">data_store</span> <span class="o">=</span> <span class="n">ModbusDataStore</span><span class="p">(</span>
        <span class="n">coils_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">discrete_inputs_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">holding_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">input_registers_size</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">)</span>

    <span class="c1"># Initialize industrial equipment data</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>  <span class="c1"># Motor status</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>  <span class="c1"># Valve status</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">2800</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">750</span><span class="p">])</span>  <span class="c1"># Motor parameters</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">248</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">318</span><span class="p">,</span> <span class="mi">447</span><span class="p">,</span> <span class="mi">682</span><span class="p">])</span>  <span class="c1"># Temperature sensors</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_discrete_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>  <span class="c1"># Limit switches</span>

    <span class="c1"># Create RTU server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">AsyncRtuModbusServer</span><span class="p">(</span>
        <span class="n">port</span><span class="o">=</span><span class="s2">&quot;COM3&quot;</span><span class="p">,</span>  <span class="c1"># Modify according to actual situation</span>
        <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
        <span class="n">data_store</span><span class="o">=</span><span class="n">data_store</span><span class="p">,</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">parity</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="n">stopbits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bytesize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RTU server configuration:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Port: COM3&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Baudrate: 9600&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Data bits: 8, Stop bits: 1, Parity: None&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Slave ID: 1&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start server</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RTU server started successfully!&quot;</span><span class="p">)</span>

        <span class="c1"># Start data simulation task</span>
        <span class="n">simulation_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">simulate_industrial_data</span><span class="p">(</span><span class="n">data_store</span><span class="p">))</span>
        <span class="n">server_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">())</span>

        <span class="c1"># Wait for tasks to complete</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">simulation_task</span><span class="p">,</span> <span class="n">server_task</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Received stop signal&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Server runtime error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping server...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server stopped&quot;</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="ascii-server-example">
<h3>ASCII Server Example<a class="headerlink" href="#ascii-server-example" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncAsciiModbusServer</span><span class="p">,</span> <span class="n">ModbusDataStore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">simulate_laboratory_experiment</span><span class="p">(</span><span class="n">data_store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate laboratory experiment process&quot;&quot;&quot;</span>
    <span class="n">experiment_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">experiment_time</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Simulate temperature control process</span>
            <span class="n">target_temps</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">read_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">current_temps</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">read_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

            <span class="c1"># Temperature gradually approaches target value</span>
            <span class="n">new_temps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">current_temps</span><span class="p">,</span> <span class="n">target_temps</span><span class="p">)):</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">current</span>
                <span class="n">change</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">experiment_time</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
                <span class="n">new_temp</span> <span class="o">=</span> <span class="n">current</span> <span class="o">+</span> <span class="n">change</span>
                <span class="n">new_temps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">new_temp</span><span class="p">))))</span>

            <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_temps</span><span class="p">)</span>

            <span class="c1"># Simulate humidity changes</span>
            <span class="n">base_humidity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">55</span><span class="p">]</span>
            <span class="n">humidity_variations</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">experiment_time</span> <span class="o">*</span> <span class="mf">0.08</span><span class="p">))</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">base_humidity</span><span class="p">]</span>
            <span class="n">humidity_variations</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">humidity_variations</span><span class="p">]</span>
            <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">humidity_variations</span><span class="p">)</span>

            <span class="c1"># Simulate pH value changes</span>
            <span class="n">base_ph</span> <span class="o">=</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">650</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">680</span><span class="p">,</span> <span class="mi">710</span><span class="p">]</span>
            <span class="n">ph_variations</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">experiment_time</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">))</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">base_ph</span><span class="p">]</span>
            <span class="n">ph_variations</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="n">ph</span><span class="p">))</span> <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">ph_variations</span><span class="p">]</span>
            <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">ph_variations</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">experiment_time</span> <span class="o">%</span> <span class="mi">15</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experiment process simulation #</span><span class="si">{</span><span class="n">experiment_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Temperature: </span><span class="si">{</span><span class="n">new_temps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Humidity: </span><span class="si">{</span><span class="n">humidity_variations</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  pH: </span><span class="si">{</span><span class="p">[</span><span class="n">ph</span><span class="o">/</span><span class="mf">100.0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ph</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ph_variations</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experiment simulation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Create data store</span>
    <span class="n">data_store</span> <span class="o">=</span> <span class="n">ModbusDataStore</span><span class="p">(</span>
        <span class="n">coils_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">discrete_inputs_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">holding_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">input_registers_size</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">)</span>

    <span class="c1"># Initialize laboratory equipment data</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>  <span class="c1"># Heater control</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>  <span class="c1"># Fan control</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">350</span><span class="p">])</span>  <span class="c1"># Target temperature</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">248</span><span class="p">,</span> <span class="mi">298</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">348</span><span class="p">])</span>  <span class="c1"># Actual temperature</span>
    <span class="n">data_store</span><span class="o">.</span><span class="n">write_discrete_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>  <span class="c1"># Door switch status</span>

    <span class="c1"># Create ASCII server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">AsyncAsciiModbusServer</span><span class="p">(</span>
        <span class="n">port</span><span class="o">=</span><span class="s2">&quot;COM4&quot;</span><span class="p">,</span>  <span class="c1"># Modify according to actual situation</span>
        <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
        <span class="n">data_store</span><span class="o">=</span><span class="n">data_store</span><span class="p">,</span>
        <span class="n">slave_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">parity</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span>
        <span class="n">stopbits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bytesize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ASCII server configuration:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Port: COM4&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Baudrate: 9600&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Data bits: 7, Stop bits: 1, Parity: Even&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Slave ID: 2&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start server</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ASCII server started successfully!&quot;</span><span class="p">)</span>

        <span class="c1"># Start experiment simulation task</span>
        <span class="n">simulation_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">simulate_laboratory_experiment</span><span class="p">(</span><span class="n">data_store</span><span class="p">))</span>
        <span class="n">server_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">())</span>

        <span class="c1"># Wait for tasks to complete</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">simulation_task</span><span class="p">,</span> <span class="n">server_task</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Received stop signal&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Server runtime error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping server...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server stopped&quot;</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="multi-server-example">
<h3>Multi-Server Example<a class="headerlink" href="#multi-server-example" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AsyncTcpModbusServer</span><span class="p">,</span>
    <span class="n">AsyncRtuModbusServer</span><span class="p">,</span>
    <span class="n">AsyncAsciiModbusServer</span><span class="p">,</span>
    <span class="n">ModbusDataStore</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MultiServerManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-server manager&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_stores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup all servers&quot;&quot;&quot;</span>
        <span class="c1"># TCP server</span>
        <span class="n">tcp_data_store</span> <span class="o">=</span> <span class="n">ModbusDataStore</span><span class="p">(</span><span class="n">coils_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">discrete_inputs_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                       <span class="n">holding_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">input_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">tcp_data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">tcp_data_store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">)))</span>

        <span class="n">tcp_server</span> <span class="o">=</span> <span class="n">AsyncTcpModbusServer</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5020</span><span class="p">,</span> <span class="n">data_store</span><span class="o">=</span><span class="n">tcp_data_store</span><span class="p">,</span> <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">[</span><span class="s2">&quot;tcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcp_server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_stores</span><span class="p">[</span><span class="s2">&quot;tcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcp_data_store</span>

        <span class="c1"># RTU server</span>
        <span class="n">rtu_data_store</span> <span class="o">=</span> <span class="n">ModbusDataStore</span><span class="p">(</span><span class="n">coils_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">discrete_inputs_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                       <span class="n">holding_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">input_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">rtu_data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">rtu_data_store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">2800</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">750</span><span class="p">])</span>

        <span class="n">rtu_server</span> <span class="o">=</span> <span class="n">AsyncRtuModbusServer</span><span class="p">(</span>
            <span class="n">port</span><span class="o">=</span><span class="s2">&quot;COM3&quot;</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span> <span class="n">data_store</span><span class="o">=</span><span class="n">rtu_data_store</span><span class="p">,</span> <span class="n">slave_id</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">[</span><span class="s2">&quot;rtu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtu_server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_stores</span><span class="p">[</span><span class="s2">&quot;rtu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtu_data_store</span>

        <span class="c1"># ASCII server</span>
        <span class="n">ascii_data_store</span> <span class="o">=</span> <span class="n">ModbusDataStore</span><span class="p">(</span><span class="n">coils_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">discrete_inputs_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                         <span class="n">holding_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">input_registers_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">ascii_data_store</span><span class="o">.</span><span class="n">write_coils</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">ascii_data_store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">350</span><span class="p">])</span>

        <span class="n">ascii_server</span> <span class="o">=</span> <span class="n">AsyncAsciiModbusServer</span><span class="p">(</span>
            <span class="n">port</span><span class="o">=</span><span class="s2">&quot;COM4&quot;</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span> <span class="n">data_store</span><span class="o">=</span><span class="n">ascii_data_store</span><span class="p">,</span> <span class="n">slave_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">parity</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="n">stopbits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bytesize</span><span class="o">=</span><span class="mi">7</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">[</span><span class="s2">&quot;ascii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii_server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_stores</span><span class="p">[</span><span class="s2">&quot;ascii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii_data_store</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_all_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start all servers&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting all servers...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">server_type</span><span class="p">,</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">server_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> server started successfully&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">server_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> server failed to start: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop_all_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop all servers&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping all servers...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">server_type</span><span class="p">,</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">server_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> server stopped&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">server_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> server failed to stop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">simulate_data_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate data changes&quot;&quot;&quot;</span>
        <span class="n">cycle</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cycle</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Update data for each server</span>
                <span class="k">for</span> <span class="n">server_type</span><span class="p">,</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_stores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">server_type</span> <span class="o">==</span> <span class="s2">&quot;tcp&quot;</span><span class="p">:</span>
                        <span class="c1"># Network monitoring data</span>
                        <span class="n">traffic_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
                        <span class="n">store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">traffic_data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">server_type</span> <span class="o">==</span> <span class="s2">&quot;rtu&quot;</span><span class="p">:</span>
                        <span class="c1"># Industrial process data</span>
                        <span class="n">temp_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
                        <span class="n">store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">temp_data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">server_type</span> <span class="o">==</span> <span class="s2">&quot;ascii&quot;</span><span class="p">:</span>
                        <span class="c1"># Laboratory data</span>
                        <span class="n">lab_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">350</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
                        <span class="n">store</span><span class="o">.</span><span class="n">write_input_registers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lab_data</span><span class="p">)</span>

                    <span class="c1"># Update counter</span>
                    <span class="n">store</span><span class="o">.</span><span class="n">write_holding_registers</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="p">[</span><span class="n">cycle</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">cycle</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data simulation cycle #</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data simulation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run forever&quot;&quot;&quot;</span>
        <span class="c1"># Start data simulation task</span>
        <span class="n">simulation_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulate_data_changes</span><span class="p">())</span>

        <span class="c1"># Start serve_forever tasks for all servers</span>
        <span class="n">server_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">server_type</span><span class="p">,</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="n">server_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">server_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> server serve_forever failed to start: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for all tasks to complete</span>
        <span class="n">all_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">simulation_task</span><span class="p">]</span> <span class="o">+</span> <span class="n">server_tasks</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">all_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">MultiServerManager</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Configure and start servers</span>
        <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">setup_servers</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">start_all_servers</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Connection information:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  TCP server: localhost:5020 (Slave ID 1)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  RTU server: COM3@9600,8,N,1 (Slave ID 2)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ASCII server: COM4@9600,7,E,1 (Slave ID 3)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Press Ctrl+C to stop all servers&quot;</span><span class="p">)</span>

        <span class="c1"># Run forever</span>
        <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Received stop signal&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Multi-server runtime error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">stop_all_servers</span><span class="p">()</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="process-control-system">
<h3>Process Control System<a class="headerlink" href="#process-control-system" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modbuslink</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncModbusClient</span><span class="p">,</span> <span class="n">AsyncTcpTransport</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProcessController</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">AsyncTcpTransport</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">AsyncModbusClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setpoints</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">,</span>
            <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="mf">1013.25</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">control_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Read process variables</span>
                    <span class="n">current_temp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_float32</span><span class="p">(</span>
                        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">100</span>
                    <span class="p">)</span>
                    <span class="n">current_pressure</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_float32</span><span class="p">(</span>
                        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">102</span>
                    <span class="p">)</span>

                    <span class="c1"># Simple proportional control</span>
                    <span class="n">temp_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoints</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_temp</span>
                    <span class="n">pressure_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoints</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_pressure</span>

                    <span class="c1"># Calculate control outputs</span>
                    <span class="n">heater_output</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="n">temp_error</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
                    <span class="n">pump_output</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="n">pressure_error</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>

                    <span class="c1"># Write control outputs</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write_float32</span><span class="p">(</span>
                        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">heater_output</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write_float32</span><span class="p">(</span>
                        <span class="n">slave_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_address</span><span class="o">=</span><span class="mi">202</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">pump_output</span>
                    <span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temp: </span><span class="si">{</span><span class="n">current_temp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C (SP: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setpoints</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">°C), &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;Heater: </span><span class="si">{</span><span class="n">heater_output</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pressure: </span><span class="si">{</span><span class="n">current_pressure</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mbar (SP: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setpoints</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> mbar), &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;Pump: </span><span class="si">{</span><span class="n">pump_output</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Control error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 1 second control loop</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_temperature_setpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setpoints</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_pressure_setpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setpoints</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="c1"># Usage</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">ProcessController</span><span class="p">(</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="mi">502</span><span class="p">)</span>

    <span class="c1"># Start control loop</span>
    <span class="n">control_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">control_loop</span><span class="p">())</span>

    <span class="c1"># Simulate setpoint changes</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">set_temperature_setpoint</span><span class="p">(</span><span class="mf">30.0</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">set_pressure_setpoint</span><span class="p">(</span><span class="mf">1020.0</span><span class="p">)</span>

    <span class="c1"># Run for a while</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">control_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="user_guide.html" class="btn btn-neutral float-left" title="User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="best_practices.html" class="btn btn-neutral float-right" title="Best Practices Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Miraitowa-la.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>